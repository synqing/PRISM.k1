# R1.1 Firmware Decode Budget Envelope (ESP32-S3)

Owner: Agent 1
Date: 2025-10-16

## Problem
Establish safe per-frame CPU cycles and memory budget for decoding packed frames at 120 FPS.

## Targets
- 120 FPS, 160 LEDs/channel
- Keep decode + handoff < frame budget with margin

## Plan
- Microbench per-frame decode kernels for candidate encodings
- Measure cycles (esp_cpu_get_cycle_count) and heap usage

## Decision (Envelope)
- Target per-frame decode budget: ≤ 0.5 ms (≤ ~120k cycles @ 240 MHz) with 2× margin to 1.0 ms for spikes.
- Memory: No per-frame heap allocs; working set ≤ 4 KB beyond destination buffers.
- Algorithmic constraint: O(N) single-pass lookup, no branching hot-paths, no dynamic data structures; table-lookup and fixed-size loops only.

## Recommended Action
- Provide the above limits to R3.4; packaging must decode with a single index→RGB lookup (and optional delta application) in one pass.
- Add cycle-count macro hooks in packaging prototype to verify budget on-device when available.

## Evidence
- Bench results; code snippets

## Harness Status (Agent 1)
- Microbench harness added: firmware/components/tests/test_decode_microbench.c
- Instrumentation header for decode code: firmware/components/core/include/prism_decode_hooks.h
- Metrics captured: cycles (esp_cpu_get_cycle_count), elapsed us (esp_timer_get_time), heap free/min (heap_caps_*).
- Current mode: no-op dummy decode to validate plumbing; ready to wire to packaging decode when Task #30 lands.
- Target validation post-integration: avg ≤ 0.5 ms, p99 ≤ 1.0 ms, single-pass O(N), no per-frame heap, working set ≤ 4 KB beyond destination buffers.
