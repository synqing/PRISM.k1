#!/usr/bin/env bash
set -euo pipefail

# Block large files (>50MB) unless managed by Git LFS
limit=$((50*1024*1024))
fail=0

staged=$(git diff --cached --name-only -z)
if [[ -n "$staged" ]]; then
  while IFS= read -r -d '' path; do
    # Skip deletions
    if ! git ls-files --error-unmatch -- "$path" >/dev/null 2>&1; then
      continue
    fi
    sha1=$(git rev-parse :"$path" 2>/dev/null || true)
    if [[ -z "$sha1" ]]; then
      continue
    fi
    size=$(git cat-file -s "$sha1")
    if [[ "$size" -gt "$limit" ]]; then
      # Allow if tracked by LFS pointer
      if git check-attr filter -- "$path" | grep -qi 'lfs'; then
        continue
      fi
      echo "[pre-commit] Blocked: $path is $(numfmt --to=iec $size), exceeds 50MB and is not tracked by LFS" >&2
      fail=1
    fi
  done < <(printf "%s" "$staged")
fi

if [[ "$fail" -ne 0 ]]; then
  echo "[pre-commit] Add large assets to Git LFS or reduce size." >&2
  exit 1
fi

exit 0
