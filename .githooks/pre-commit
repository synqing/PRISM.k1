#!/bin/bash
# .githooks/pre-commit
#
# CANON.md Protection Hook
# Prevents manual edits to CANON.md
# Enforces that CANON.md is only modified via generate-canon.sh

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check if CANON.md is being committed
if git diff --cached --name-only | grep -q ".taskmaster/CANON.md"; then
    # Check if this is an auto-generated commit
    if ! git log --format=%B -n 1 | grep -q "\[AUTO\]"; then
        echo -e "${RED}âœ— BLOCKED: Manual edit to CANON.md detected!${NC}"
        echo ""
        echo "CANON.md must ONLY be generated via scripts/generate-canon.sh"
        echo ""
        echo "To fix:"
        echo "  1. Unstage CANON.md: git reset HEAD .taskmaster/CANON.md"
        echo "  2. Revert manual changes: git checkout .taskmaster/CANON.md"
        echo "  3. If you need to change specifications:"
        echo "     a. Create/modify an ADR in .taskmaster/decisions/"
        echo "     b. Run: ./scripts/generate-canon.sh"
        echo "     c. Commit with message: '[AUTO] Generated CANON from ADRs'"
        echo ""
        exit 1
    fi
fi

# Check if ADRs are being committed
if git diff --cached --name-only | grep -q ".taskmaster/decisions/"; then
    echo -e "${YELLOW}ADR changes detected - remember to regenerate CANON.md${NC}"
    echo "Run: ./scripts/generate-canon.sh"
fi

exit 0
